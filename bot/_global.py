import discord
from discord import app_commands
from discord.ext import commands
import config
import discord.utils
import urllib.parse


def setup_global_commands(bot: commands.Bot):
    @bot.tree.command(name="clear", description="Xo√° tin nh·∫Øn trong k√™nh")
    @app_commands.describe(amount="S·ªë l∆∞·ª£ng tin nh·∫Øn c·∫ßn xo√° (1-100)")
    @app_commands.checks.has_permissions(manage_messages=True)
    async def clear_messages(interaction: discord.Interaction, amount: int):
        try:
            if amount < 1 or amount > 100:
                await interaction.response.send_message("S·ªë l∆∞·ª£ng tin nh·∫Øn c·∫ßn xo√° ph·∫£i t·ª´ 1 ƒë·∫øn 100!", ephemeral=True)
                return

            await interaction.response.defer(ephemeral=True)
            deleted = await interaction.channel.purge(limit=amount)
            await interaction.followup.send(
                f"‚úÖ ƒê√£ xo√° {len(deleted)} tin nh·∫Øn.",
                ephemeral=True
            )

        except discord.Forbidden:
            if not interaction.response.is_done():
                await interaction.response.send_message(
                    "‚ùå Bot kh√¥ng c√≥ quy·ªÅn xo√° tin nh·∫Øn trong k√™nh n√†y!",
                    ephemeral=True
                )
            else:
                await interaction.followup.send(
                    "‚ùå Bot kh√¥ng c√≥ quy·ªÅn xo√° tin nh·∫Øn trong k√™nh n√†y!",
                    ephemeral=True
                )
        except Exception as e:
            if not interaction.response.is_done():
                await interaction.response.send_message(
                    f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                    ephemeral=True
                )
            else:
                await interaction.followup.send(
                    f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                    ephemeral=True
                )

    @bot.tree.command(name="userinfo", description="Xem th√¥ng tin c·ªßa ng∆∞·ªùi d√πng")
    @app_commands.describe(member="Ng∆∞·ªùi d√πng c·∫ßn xem th√¥ng tin")
    async def user_info(interaction: discord.Interaction, member: discord.Member = None):
        try:
            target = member or interaction.user
            embed = discord.Embed(
                title=f"üë§ Th√¥ng tin ng∆∞·ªùi d√πng",
                description=f"Th√¥ng tin chi ti·∫øt v·ªÅ {target.mention}",
                color=discord.Color.blue()
            )

            embed.set_thumbnail(url=target.display_avatar.url)
            embed.set_author(name=str(target),
                             icon_url=target.display_avatar.url)

            embed.add_field(
                name="üìù Th√¥ng tin chung",
                value=f"**T√™n hi·ªÉn th·ªã:** {target.display_name}\n"
                f"**ID:** {target.id}\n"
                f"**Bot:** {'ü§ñ C√≥' if target.bot else 'üë§ Kh√¥ng'}",
                inline=False
            )

            created_time = int(target.created_at.timestamp())
            joined_time = int(target.joined_at.timestamp())
            embed.add_field(
                name="‚è∞ Th·ªùi gian",
                value=f"**Tham gia Discord:** <t:{
                    created_time}:D> (<t:{created_time}:R>)\n"
                f"**Tham gia Server:** <t:{
                    joined_time}:D> (<t:{joined_time}:R>)",
                inline=False
            )

            roles = [role.mention for role in reversed(target.roles[1:])]
            embed.add_field(
                name=f"üé≠ Roles [{len(roles)}]",
                value=" ".join(roles) if roles else "Kh√¥ng c√≥ role",
                inline=False
            )

            embed.set_footer(
                text=f"Y√™u c·∫ßu b·ªüi {interaction.user}",
                icon_url=interaction.user.display_avatar.url
            )

            await interaction.response.send_message(embed=embed)

        except Exception as e:
            await interaction.response.send_message(
                f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                ephemeral=True
            )

    @bot.tree.command(name='pay', description='T·∫°o m√£ QR thanh to√°n')
    @app_commands.describe(
        bank='Ch·ªçn ng√¢n h√†ng',
        account_number='S·ªë t√†i kho·∫£n',
        amount='S·ªë ti·ªÅn c·∫ßn chuy·ªÉn',
        content='N·ªôi dung chuy·ªÉn kho·∫£n'
    )
    @app_commands.choices(bank=[
        app_commands.Choice(name='VietinBank', value='ICB'),
        app_commands.Choice(name='Vietcombank', value='VCB'),
        app_commands.Choice(name='BIDV', value='BIDV'),
        app_commands.Choice(name='ACB', value='ACB'),
    ])
    async def pay(
        interaction: discord.Interaction,
        bank: app_commands.Choice[str],
        account_number: str,
        amount: int,
        content: str
    ):
        try:
            encoded_content = urllib.parse.quote(content)
            qr_url = f"https://img.vietqr.io/image/{bank.value}-{
                account_number}-compact2.jpg?amount={amount}&addInfo={encoded_content}"

            embed = discord.Embed(
                title="üè¶ M√£ QR Thanh To√°n",
                description=f"**S·ªë ti·ªÅn:** {
                    amount:,} VNƒê\n**N·ªôi dung:** {content}",
                color=discord.Color.green()
            )

            embed.add_field(
                name="üìù Th√¥ng tin t√†i kho·∫£n",
                value=f"**Ng√¢n h√†ng:** {
                    bank.name}\n**S·ªë t√†i kho·∫£n:** {account_number}",
                inline=False
            )

            embed.set_image(url=qr_url)
            embed.set_footer(
                text=f"Y√™u c·∫ßu b·ªüi {interaction.user}",
                icon_url=interaction.user.display_avatar.url
            )

            await interaction.response.send_message(embed=embed)

        except Exception as e:
            await interaction.response.send_message(
                f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                ephemeral=True
            )

    @bot.tree.command(name="avatar", description="Xem avatar c·ªßa ng∆∞·ªùi d√πng")
    @app_commands.describe(member="Ng∆∞·ªùi d√πng c·∫ßn xem avatar")
    async def avatar(interaction: discord.Interaction, member: discord.Member = None):
        try:
            target = member or interaction.user
            embed = discord.Embed(
                title=f"üñºÔ∏è Avatar c·ªßa {target.display_name}",
                description="Nh·∫•p v√†o c√°c link b√™n d∆∞·ªõi ƒë·ªÉ t·∫£i avatar v·ªõi ƒë·ªãnh d·∫°ng t∆∞∆°ng ·ª©ng",
                color=target.color
            )

            embed.set_author(
                name=str(target),
                icon_url=target.display_avatar.url
            )

            embed.set_image(url=target.display_avatar.url)

            formats = []
            if target.display_avatar.is_animated():
                formats.append(
                    f"[`GIF`]({target.display_avatar.replace(format='gif', size=4096).url})")
            formats.extend([
                f"[`PNG`]({target.display_avatar.replace(
                    format='png', size=4096).url})",
                f"[`JPG`]({target.display_avatar.replace(
                    format='jpg', size=4096).url})",
                f"[`WEBP`]({target.display_avatar.replace(
                    format='webp', size=4096).url})"
            ])

            embed.add_field(
                name="üì• T·∫£i xu·ªëng",
                value=" ‚Ä¢ ".join(formats),
                inline=False
            )

            embed.set_footer(
                text=f"ID: {target.id}",
                icon_url=interaction.guild.icon.url if interaction.guild.icon else None
            )

            embed.timestamp = discord.utils.utcnow()

            await interaction.response.send_message(embed=embed)

        except Exception as e:
            await interaction.response.send_message(
                f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                ephemeral=True
            )

    @bot.tree.command(name="chat", description="Chat v·ªõi AI s·ª≠ d·ª•ng Gemini")
    @app_commands.describe(prompt="N·ªôi dung b·∫°n mu·ªën h·ªèi AI")
    async def chat(interaction: discord.Interaction, prompt: str):
        try:
            await interaction.response.defer()

            embed = discord.Embed(
                title="üí¨ Gemini AI",
                description="*ƒêang x·ª≠ l√Ω c√¢u tr·∫£ l·ªùi...*",
                color=discord.Color.blue()
            )

            try:
                import google.generativeai as genai
                genai.configure(api_key=config.GEMINI_API_KEY)
                model = genai.GenerativeModel('gemini-1.5-flash')
                response = model.generate_content(prompt)
                embed.description = response.text
                embed.add_field(name="C√¢u h·ªèi", value=prompt, inline=False)
                await interaction.followup.send(embed=embed)

            except Exception as e:
                embed.description = f"‚ùå L·ªói khi g·ªçi API Gemini: {str(e)}"
                embed.color = discord.Color.red()
                await interaction.followup.send(embed=embed)

        except Exception as e:
            await interaction.followup.send(
                f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                ephemeral=True
            )

    @bot.tree.command(name="server", description="Xem th√¥ng tin v·ªÅ server v√† c·∫•u h√¨nh m√°y")
    async def server_info(interaction: discord.Interaction):
        try:
            guild = interaction.guild
            embed = discord.Embed(
                title=f"üìä Th√¥ng tin Server: {guild.name}",
                color=discord.Color.blue()
            )

            embed.add_field(
                name="üÜî Server ID",
                value=guild.id,
                inline=True
            )
            embed.add_field(
                name="üëë Ch·ªß server",
                value=guild.owner.mention,
                inline=True
            )
            embed.add_field(
                name="üìÖ Ng√†y t·∫°o",
                value=guild.created_at.strftime("%d/%m/%Y"),
                inline=True
            )

            embed.add_field(
                name="üë• T·ªïng th√†nh vi√™n",
                value=guild.member_count,
                inline=True
            )
            embed.add_field(
                name="ü§ñ S·ªë l∆∞·ª£ng bot",
                value=len([m for m in guild.members if m.bot]),
                inline=True
            )
            embed.add_field(
                name="üìù S·ªë l∆∞·ª£ng k√™nh",
                value=len(guild.channels),
                inline=True
            )

            embed.add_field(
                name="üöÄ Boost Level",
                value=f"Level {guild.premium_tier}",
                inline=True
            )
            embed.add_field(
                name="üíé S·ªë l∆∞·ª£ng boost",
                value=guild.premium_subscription_count,
                inline=True
            )

            if guild.icon:
                embed.set_thumbnail(url=guild.icon.url)

            await interaction.response.send_message(embed=embed)

        except Exception as e:
            await interaction.response.send_message(
                f"‚ùå ƒê√£ x·∫£y ra l·ªói: {str(e)}",
                ephemeral=True
            )
